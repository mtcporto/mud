<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>MUD Fatal Dimensions</title>
  <meta name="theme-color" content="#051f1b">
  <style>
    html, body {
      height: 100%;
    }
    body {
      background: linear-gradient(135deg, #051f1b 0%, #0d2e2b 100%);
      color: #00ff90;
      font-family: 'Fira Mono', 'Menlo', monospace;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      height: 100dvh;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: #02130fcb;
      border-bottom: 1.5px solid #00b46e40;
      gap: 1rem;
    }
    .inputs {
      display: flex;
      gap: 0.5rem;
      flex: 1 1 0;
      align-items: center;
      flex-wrap: wrap;
      min-width: 0;
    }
    .inputs input {
      background: #091c17;
      color: #00ff90;
      border: 1.5px solid #00b46e80;
      border-radius: 6px;
      padding: 0.55em 0.7em;
      font-size: 1rem;
      width: 7.5em;
      max-width: 38vw;
      font-family: inherit;
      outline: none;
      transition: border .2s;
    }
    .inputs input:focus {
      border: 1.5px solid #00ff90;
      background: #102b22;
    }
    .actions {
      display: flex;
      gap: 0.5rem;
    }
    button {
      background: #00b46e;
      color: #0a1917;
      border: none;
      border-radius: 7px;
      padding: 0.7em 1.1em;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: background .18s, color .18s, box-shadow .18s;
      box-shadow: 0 1px 4px #0005;
      outline: none;
      min-width: 95px;
    }
    button:active {
      background: #00ff90;
      color: #051f1b;
    }
    button[disabled] {
      background: #03372c;
      color: #77c4a6;
      cursor: not-allowed;
      opacity: 0.7;
    }
    .terminal {
      flex: 1 1 0;
      background: #061d17e6;
      margin: 0;
      padding: 0.5rem 0.4rem 0.5rem 0.4rem;
      overflow-y: auto;
      overflow-x: hidden;
      font-size: 15px;
      border-bottom: 1.5px solid #00b46e40;
      border-top: 1.5px solid #00b46e40;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 0;
      max-height: 64vh;
      line-height: 1.38;
      letter-spacing: 0.01em;
      box-shadow: 0 0 6px #00ff9040 inset;
    }
    .msg { margin-bottom: 0.4rem; }
    .msg.system { color: #ffe66b; opacity: .88; }
    .msg.error { color: #ff3f51; font-weight: bold; }
    .msg.user { color: #00e6ff; }
    .msg.ai { color: #be7dff; }
    .msg.server { color: #00ff90; }
    .msg.time { font-size: 12px; color: #50b36d; float: right; opacity: 0.7;}
    .input-bar {
      display: flex;
      background: #02130fcb;
      padding: 0.7rem 1rem 0.7rem 1rem;
      align-items: center;
      gap: 0.5rem;
      border-top: 1.5px solid #00b46e40;
    }
    .input-bar input[type="text"] {
      flex: 1;
      padding: 0.7em 1em;
      font-size: 1.04rem;
      border-radius: 8px;
      background: #0d2e25;
      color: #00ff90;
      border: 1.5px solid #009d5f55;
      outline: none;
      font-family: inherit;
      transition: border .18s;
    }
    .input-bar input[type="text"]:focus {
      border: 1.5px solid #00ff90;
      background: #122e28;
    }
    .hint {
      font-size: .93em;
      color: #6dbb99;
      margin-left: 0.8em;
      opacity: .72;
      letter-spacing: 0.02em;
    }
    .mobile-hide {
      display: block;
    }
    @media (max-width: 700px) {
      .inputs input { width: 5.5em; max-width: 25vw; font-size: .98em;}
      .mobile-hide { display: none; }
      .terminal { font-size: 14px; max-height: 44vh; }
    }
    @media (max-width: 420px) {
      .topbar { flex-direction: column; align-items: stretch; gap: .2rem;}
      .inputs { flex-wrap: wrap; flex-direction: column; gap: 0.25rem;}
      .actions { gap: 0.25rem;}
      .terminal { font-size: 13px; }
      .input-bar { padding: 0.7rem 0.6rem;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="inputs">
      <input id="host" type="text" value="mud.fataldimensions.nl" autocomplete="off" autocapitalize="off" spellcheck="false" title="Servidor" />
      <input id="port" type="number" value="4000" min="1" max="65535" autocomplete="off" title="Porta" />
    </div>
    <div class="actions">
      <button id="connectBtn" onclick="mud.toggleConnection()">Conectar</button>
      <button id="aiBtn" onclick="mud.toggleAI()" disabled>Ativar IA</button>
    </div>
  </div>
  <div id="terminal" class="terminal"></div>
  <form class="input-bar" onsubmit="mud.handleForm(event)">
    <input id="cmd" type="text" placeholder="Digite comando e ENTER" autocomplete="off" disabled />
    <span class="hint mobile-hide">ENTER envia, ↑↓ histórico, TAB auto-completa</span>
  </form>
  <script>
    class MUD {
      constructor() {
        this.terminal = document.getElementById('terminal');
        this.cmd = document.getElementById('cmd');
        this.connectBtn = document.getElementById('connectBtn');
        this.aiBtn = document.getElementById('aiBtn');
        this.hostInput = document.getElementById('host');
        this.portInput = document.getElementById('port');
        this.api = '/api/proxy';
        this.connectionId = null;
        this.isConnected = false;
        this.isAi = false;
        this.isAiThinking = false;
        this.history = [];
        this.histIdx = -1;
        this.lastPing = null;
        this.scroll();
        this.print('Cliente MUD pronto.', 'system');
        this.attachEvents();
      }

      attachEvents() {
        this.cmd.addEventListener('keydown', (e) => this.handleKey(e));
        this.cmd.addEventListener('focus', () => this.scroll());
        window.addEventListener('resize', () => this.scroll());
      }

      scroll() {
        setTimeout(() => {
          this.terminal.scrollTop = this.terminal.scrollHeight + 100;
        }, 15);
      }

      print(msg, type = 'server') {
        const div = document.createElement('div');
        div.className = 'msg ' + type;
        if (type === 'user' || type === 'ai') {
          div.textContent = msg;
        } else {
          // server/system/error
          div.innerHTML = msg.replace(/\n/g, '<br>');
        }
        const t = document.createElement('span');
        t.className = 'msg time';
        t.textContent = new Date().toLocaleTimeString('pt-BR').slice(0, 5);
        div.appendChild(t);
        this.terminal.appendChild(div);
        this.scroll();
      }

      setConnected(yes) {
        this.isConnected = yes;
        this.connectBtn.textContent = yes ? 'Desconectar' : 'Conectar';
        this.connectBtn.disabled = false;
        this.hostInput.disabled = yes;
        this.portInput.disabled = yes;
        this.cmd.disabled = !yes;
        this.aiBtn.disabled = !yes;
        if (!yes) this.cmd.value = '';
        document.getElementById('connectionStatus').className = 'status-indicator ' + (yes ? 'connected' : 'disconnected');
        document.getElementById('connectionStatus').textContent = yes ? 'Conectado' : 'Desconectado';
        if (yes) setTimeout(() => this.cmd.focus(), 140);
      }

      setAI(on) {
        this.isAi = on;
        this.aiBtn.textContent = on ? 'Desativar IA' : 'Ativar IA';
        this.aiBtn.className = on ? 'enabled' : '';
      }

      setAIThinking(thinking) {
        this.isAiThinking = thinking;
        this.aiBtn.disabled = thinking;
        this.aiBtn.textContent = thinking ? 'IA Pensando...' : (this.isAi ? 'Desativar IA' : 'Ativar IA');
      }

      async toggleConnection() {
        if (this.isConnected) {
          this.disconnect();
        } else {
          this.connect();
        }
      }

      async connect() {
        const host = this.hostInput.value.trim();
        const port = +this.portInput.value;
        this.connectBtn.disabled = true;
        this.print(`Conectando a ${host}:${port}...`, 'system');
        try {
          const r = await fetch(this.api, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'connect', host, port })
          });
          const data = await r.json();
          if (!data.success) throw new Error(data.error || 'Falha na conexão');
          this.connectionId = data.connectionId;
          this.listen();
          this.setConnected(true);
          this.print('Conectado! Bem-vindo.', 'system');
        } catch (e) {
          this.print('Erro ao conectar: ' + e.message, 'error');
          this.setConnected(false);
        }
      }

      async disconnect() {
        if (!this.connectionId) return;
        fetch(this.api, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'disconnect', connectionId: this.connectionId })
        }).catch(() => {});
        this.connectionId = null;
        this.setConnected(false);
        this.print('Conexão encerrada.', 'system');
      }

      async handleForm(e) {
        e.preventDefault();
        if (!this.isConnected) return;
        let cmd = this.cmd.value;
        // ENTER vazio: envia ENTER para o MUD
        if (!cmd) {
          await this.sendCommand('');
          return;
        }
        await this.sendCommand(cmd);
        this.cmd.value = '';
      }

      async sendCommand(cmd) {
        if (!this.isConnected || !this.connectionId) return;
        this.print(cmd || '[ENTER]', 'user');
        this.history.push(cmd);
        this.histIdx = this.history.length;
        await fetch(this.api, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'send', connectionId: this.connectionId, command: cmd })
        });
      }

      handleKey(e) {
        if (e.key === "ArrowUp") {
          e.preventDefault();
          if (this.histIdx > 0) {
            this.histIdx--;
            this.cmd.value = this.history[this.histIdx] || '';
            setTimeout(() => this.cmd.setSelectionRange(99, 99), 0);
          }
        } else if (e.key === "ArrowDown") {
          e.preventDefault();
          if (this.histIdx < this.history.length - 1) {
            this.histIdx++;
            this.cmd.value = this.history[this.histIdx] || '';
            setTimeout(() => this.cmd.setSelectionRange(99, 99), 0);
          } else {
            this.histIdx = this.history.length;
            this.cmd.value = '';
          }
        } else if (e.key === "Tab") {
          e.preventDefault();
          const c = this.cmd.value.toLowerCase();
          const cmds = ['look', 'inventory', 'score', 'who', 'north', 'south', 'east', 'west', 'up', 'down', 'help', 'quit'];
          const found = cmds.find(cmd => cmd.startsWith(c));
          if (found) this.cmd.value = found;
        }
      }

      toggleAI() {
        if (!this.isConnected) return;
        this.setAI(!this.isAi);
        if (this.isAi) this.print('IA ativada. Ela irá jogar sozinha!', 'system');
        else this.print('IA desativada.', 'system');
      }

      listen() {
        if (!this.connectionId) return;
        if (this.eventSource) this.eventSource.close();
        this.eventSource = new EventSource(`${this.api}?action=stream&connectionId=${this.connectionId}`);
        this.eventSource.onopen = () => {};
        this.eventSource.onmessage = (ev) => {
          let data;
          try { data = JSON.parse(ev.data); } catch { return; }
          if (data.type === 'mud_output' && data.content) {
            this.print(data.content, 'server');
            if (this.isAi && !this.isAiThinking) this.runAI(data.content);
          } else if (data.type === 'disconnect') {
            this.print('Conexão encerrada pelo servidor.', 'system');
            this.setConnected(false);
          } else if (data.type === 'error') {
            this.print('Erro: ' + data.message, 'error');
          }
        };
        this.eventSource.onerror = () => {
          this.print('Erro na conexão com servidor.', 'error');
          this.setConnected(false);
        };
      }

      runAI(output) {
        this.setAIThinking(true);
        setTimeout(() => {
          const lower = (output || '').toLowerCase();
          let acao = '';
          if (lower.includes('by what name')) acao = 'Visitante';
          else if (lower.includes('password')) acao = '';
          else if (lower.includes('hit return') || lower.includes('pressione enter')) acao = '';
          else if (lower.includes('north')) acao = 'north';
          else if (lower.includes('south')) acao = 'south';
          else if (lower.includes('east')) acao = 'east';
          else if (lower.includes('west')) acao = 'west';
          else if (lower.includes('up')) acao = 'up';
          else if (lower.includes('down')) acao = 'down';
          else acao = ['look','who','help','inventory','score'][Math.floor(Math.random()*5)];
          if (acao !== undefined) {
            this.print('IA: ' + (acao ? `Enviando "${acao}"` : 'Enviando ENTER'), 'ai');
            this.sendCommand(acao);
          }
          this.setAIThinking(false);
        }, 1200 + Math.random()*700);
      }
    }
    const mud = new MUD();
    window.mud = mud;
  </script>
</body>
</html>
