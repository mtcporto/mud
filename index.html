<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>MUD Fatal Dimensions com Gemini IA</title>
  <meta name="theme-color" content="#051f1b">
  <style>
    body { background: #051f1b; color: #00ff90; font-family: 'Fira Mono', monospace; margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column; }
    .topbar { display: flex; gap: .6em; align-items: center; padding: 0.8em 1em; background: #02130fcb; border-bottom: 1.5px solid #00b46e40; flex-wrap: wrap;}
    .inputs input { background: #091c17; color: #00ff90; border: 1.5px solid #00b46e80; border-radius: 6px; padding: 0.55em 0.7em; font-size: 1rem; width: 7.5em; font-family: inherit; outline: none; }
    .inputs input:focus { border: 1.5px solid #00ff90; background: #102b22; }
    .actions { display: flex; gap: 0.5rem; }
    button { background: #00b46e; color: #0a1917; border: none; border-radius: 7px; padding: 0.7em 1.1em; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background .18s; min-width: 95px;}
    button:active { background: #00ff90; color: #051f1b;}
    button[disabled] {background: #03372c; color: #77c4a6; cursor: not-allowed; opacity: 0.7;}
    .terminal { flex: 1 1 0; background: #061d17e6; margin: 0; padding: 0.5rem 0.4rem; overflow-y: auto; font-size: 15px; border-bottom: 1.5px solid #00b46e40; border-top: 1.5px solid #00b46e40; white-space: pre-wrap; min-height: 0; max-height: 64vh; }
    .msg { margin-bottom: 0.4rem; }
    .msg.system { color: #ffe66b; opacity: .88; }
    .msg.error { color: #ff3f51; font-weight: bold; }
    .msg.user { color: #00e6ff; }
    .msg.ai { color: #be7dff; }
    .msg.server { color: #00ff90; }
    .msg.time { font-size: 12px; color: #50b36d; float: right; opacity: 0.7;}
    .input-bar { display: flex; background: #02130fcb; padding: 0.7rem 1rem; align-items: center; gap: 0.5rem; border-top: 1.5px solid #00b46e40;}
    .input-bar input[type="text"] { flex: 1; padding: 0.7em 1em; font-size: 1.04rem; border-radius: 8px; background: #0d2e25; color: #00ff90; border: 1.5px solid #009d5f55; outline: none; font-family: inherit;}
    .input-bar input[type="text"]:focus { border: 1.5px solid #00ff90; background: #122e28; }
    .hint { font-size: .93em; color: #6dbb99; margin-left: 0.8em; opacity: .72; letter-spacing: 0.02em; }
    .ia-log-bar { background: #0a221b; border-top: 1.5px solid #007a4a40; font-size: 12px; font-family: inherit; color: #9cffdc; padding: 0.6em 1.1em; min-height: 2.2em; }
    .ia-log-bar strong { color: #00ff90; margin-right: 0.6em; }
    .ia-log-action { margin-right: 1.2em; color: #be7dff; font-weight: bold; font-family: inherit;}
    @media (max-width: 700px) {
      .inputs input { width: 5.5em; font-size: .98em;}
      .terminal { font-size: 14px; max-height: 44vh; }
      .ia-log-bar { font-size: 11px; padding: 0.6em 0.5em;}
    }
    @media (max-width: 420px) {
      .topbar { flex-direction: column; gap: .2rem;}
      .inputs { flex-direction: column; gap: 0.25rem;}
      .actions { gap: 0.25rem;}
      .terminal { font-size: 13px; }
      .input-bar { padding: 0.7rem 0.6rem;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="inputs">
      <input id="host" type="text" value="mud.fataldimensions.nl" autocomplete="off" spellcheck="false" title="Servidor" />
      <input id="port" type="number" value="4000" min="1" max="65535" title="Porta" />
    </div>
    <div class="actions">
      <button id="connectBtn" onclick="mud.toggleConnection()">Conectar</button>
      <button id="aiBtn" onclick="mud.toggleAI()" disabled>Ativar IA Gemini</button>
    </div>
  </div>
  <div id="terminal" class="terminal"></div>
  <form class="input-bar" onsubmit="mud.handleForm(event)">
    <input id="cmd" type="text" placeholder="Digite comando e ENTER" autocomplete="off" disabled />
    <span class="hint">ENTER envia, ↑↓ histórico, TAB auto-completa</span>
  </form>
  <div class="ia-log-bar" id="iaLogBar"><strong>Log IA:</strong> Nenhuma ação ainda.</div>
  <script>
    class MUD {
      constructor() {
        this.terminal = document.getElementById('terminal');
        this.cmd = document.getElementById('cmd');
        this.connectBtn = document.getElementById('connectBtn');
        this.aiBtn = document.getElementById('aiBtn');
        this.hostInput = document.getElementById('host');
        this.portInput = document.getElementById('port');
        this.api = '/api/proxy';
        this.connectionId = null;
        this.isConnected = false;
        this.isAi = false;
        this.isAiThinking = false;
        this.history = [];
        this.histIdx = -1;
        this.iaLog = [];
        this.maxIaLog = 12;
        this.scroll();
        this.print('Cliente MUD pronto.', 'system');
        this.attachEvents();
        this.updateIaLog();
      }

      attachEvents() {
        this.cmd.addEventListener('keydown', (e) => this.handleKey(e));
        this.cmd.addEventListener('focus', () => this.scroll());
        window.addEventListener('resize', () => this.scroll());
      }

      scroll() {
        setTimeout(() => {
          this.terminal.scrollTop = this.terminal.scrollHeight + 100;
        }, 15);
      }

      print(msg, type = 'server') {
        const div = document.createElement('div');
        div.className = 'msg ' + type;
        div.innerHTML = (type === 'user' || type === 'ai') ? msg : msg.replace(/\n/g, '<br>');
        const t = document.createElement('span');
        t.className = 'msg time';
        t.textContent = new Date().toLocaleTimeString('pt-BR').slice(0, 5);
        div.appendChild(t);
        this.terminal.appendChild(div);
        this.scroll();
      }

      setConnected(yes) {
        this.isConnected = yes;
        this.connectBtn.textContent = yes ? 'Desconectar' : 'Conectar';
        this.connectBtn.disabled = false;
        this.hostInput.disabled = yes;
        this.portInput.disabled = yes;
        this.cmd.disabled = !yes;
        this.aiBtn.disabled = !yes;
        if (!yes) this.cmd.value = '';
        if (yes) setTimeout(() => this.cmd.focus(), 120);
      }

      setAI(on) {
        this.isAi = on;
        this.aiBtn.textContent = on ? 'Desativar IA Gemini' : 'Ativar IA Gemini';
        this.aiBtn.className = on ? 'enabled' : '';
      }

      setAIThinking(thinking) {
        this.isAiThinking = thinking;
        this.aiBtn.disabled = thinking;
        this.aiBtn.textContent = thinking ? 'IA Pensando...' : (this.isAi ? 'Desativar IA Gemini' : 'Ativar IA Gemini');
      }

      async toggleConnection() {
        if (this.isConnected) this.disconnect();
        else this.connect();
      }

      async connect() {
        const host = this.hostInput.value.trim();
        const port = +this.portInput.value;
        this.connectBtn.disabled = true;
        this.print(`Conectando a ${host}:${port}...`, 'system');
        try {
          const r = await fetch(this.api, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'connect', host, port })
          });
          const data = await r.json();
          if (!data.success) throw new Error(data.error || 'Falha na conexão');
          this.connectionId = data.connectionId;
          this.listen();
          this.setConnected(true);
          this.print('Conectado! Bem-vindo.', 'system');
        } catch (e) {
          this.print('Erro ao conectar: ' + e.message, 'error');
          this.setConnected(false);
        }
      }

      async disconnect() {
        if (this.listenAbort) this.listenAbort.abort();
        if (!this.connectionId) return;
        fetch(this.api, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'disconnect', connectionId: this.connectionId })
        }).catch(() => {});
        this.connectionId = null;
        this.setConnected(false);
        this.print('Conexão encerrada.', 'system');
      }

      async handleForm(e) {
        e.preventDefault();
        if (!this.isConnected) return;
        let cmd = this.cmd.value;
        // ENTER vazio: envia ENTER para o MUD
        if (!cmd) {
          await this.sendCommand('');
          return;
        }
        await this.sendCommand(cmd);
        this.cmd.value = '';
      }

      async sendCommand(cmd) {
        if (!this.isConnected || !this.connectionId) return;
        this.print(cmd || '[ENTER]', 'user');
        this.history.push(cmd);
        this.histIdx = this.history.length;
        await fetch(this.api, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'send', connectionId: this.connectionId, command: cmd })
        });
      }

      handleKey(e) {
        if (e.key === "ArrowUp") {
          e.preventDefault();
          if (this.histIdx > 0) {
            this.histIdx--;
            this.cmd.value = this.history[this.histIdx] || '';
            setTimeout(() => this.cmd.setSelectionRange(99, 99), 0);
          }
        } else if (e.key === "ArrowDown") {
          e.preventDefault();
          if (this.histIdx < this.history.length - 1) {
            this.histIdx++;
            this.cmd.value = this.history[this.histIdx] || '';
            setTimeout(() => this.cmd.setSelectionRange(99, 99), 0);
          } else {
            this.histIdx = this.history.length;
            this.cmd.value = '';
          }
        } else if (e.key === "Tab") {
          e.preventDefault();
          const c = this.cmd.value.toLowerCase();
          const cmds = ['look', 'inventory', 'score', 'who', 'north', 'south', 'east', 'west', 'up', 'down', 'help', 'quit'];
          const found = cmds.find(cmd => cmd.startsWith(c));
          if (found) this.cmd.value = found;
        }
      }

      toggleAI() {
        if (!this.isConnected) return;
        this.setAI(!this.isAi);
        if (this.isAi) this.print('IA Gemini ativada. Ela irá jogar sozinha!', 'system');
        else this.print('IA desativada.', 'system');
      }

      listen() {
        if (!this.connectionId) return;
        if (this.eventSource) this.eventSource.close();
        this.listenAbort = new AbortController();
        this.eventSource = new EventSource(`${this.api}?action=stream&connectionId=${this.connectionId}`);
        this.eventSource.onopen = () => {};
        this.eventSource.onmessage = (ev) => {
          let data;
          try { data = JSON.parse(ev.data); } catch { return; }
          if (data.type === 'mud_output' && data.content) {
            this.print(data.content, 'server');
            if (this.isAi && !this.isAiThinking) this.runGeminiAI(data.content);
          } else if (data.type === 'disconnect') {
            this.print('Conexão encerrada pelo servidor.', 'system');
            this.setConnected(false);
          } else if (data.type === 'error') {
            this.print('Erro: ' + data.message, 'error');
          }
        };
        this.eventSource.onerror = () => {
          this.print('Erro na conexão com servidor.', 'error');
          this.setConnected(false);
        };
      }

      updateIaLog() {
        const logBar = document.getElementById("iaLogBar");
        if (!this.iaLog.length) {
          logBar.innerHTML = `<strong>Log IA:</strong> Nenhuma ação ainda.`;
        } else {
          logBar.innerHTML = `<strong>Log IA:</strong> ` +
            this.iaLog.slice(-this.maxIaLog).map(a => `<span class="ia-log-action">${a}</span>`).join("");
        }
      }

      addIaLog(action) {
        this.iaLog.push(action);
        if (this.iaLog.length > this.maxIaLog*2) this.iaLog = this.iaLog.slice(-this.maxIaLog*2);
        this.updateIaLog();
      }

      async runGeminiAI(output) {
        this.setAIThinking(true);
        try {
          const key = "AIzaSyDRmlTW97Ij9SRu1Q2Vm3ZIqj8h8Yx9Nr8";
          // Prompt aprimorado para contexto real de MUD/chat
          const prompt = `Você está jogando um MUD (um RPG de texto clássico, tipo telnet). 
O texto abaixo é o que o "mestre do jogo" está dizendo para você (o humano do outro lado). 
Você só pode responder UMA coisa por vez, como se fosse um chat.
Sempre responda exatamente o que o mestre do jogo pedir, de acordo com as regras do MUD.

- Se pedir o nome do personagem, use: gemini
- Se pedir senha, use: @Fatal#123 (ou tente variações parecidas se não aceitar)
- Se pedir e-mail, use: devosw2p@gmail.com
- Se pedir para confirmar algo (Yes/No), responda Yes ou No conforme apropriado
- Se pedir uma opção (classe, raça, sexo), escolha uma opção comum e válida, como um jogador experiente.
- Só envie ENTER (resposta em branco) se pedir explicitamente.
- Não pule etapas.
- Não explique nada, apenas envie o comando/resposta que seria digitado no MUD.
- O contexto é RPG, então aja como um jogador de MUD.

Texto do jogo:
"""
${output}
"""
Responda apenas com o comando ou palavra EXATA a ser digitada (apenas UMA linha, sem explicação, sem aspas, sem pontuação extra).`;

          const delay = 1200 + Math.random()*1800;
          setTimeout(async () => {
            const res = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=" + encodeURIComponent(key), {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }]
              })
            });
            const j = await res.json();
            let comando = '';
            if (j.candidates && j.candidates.length) {
              comando = (j.candidates[0].content.parts[0].text || '').trim();
            }
            if (comando.toLowerCase() === 'enter') comando = '';
            if (!comando) {
              this.print('IA: Pressionando ENTER', 'ai');
              this.addIaLog('[ENTER]');
            } else {
              this.print('IA: Enviando "' + comando + '"', 'ai');
              this.addIaLog(comando);
            }
            await this.sendCommand(comando);
            this.setAIThinking(false);
          }, delay);
        } catch (e) {
          this.print('Falha IA Gemini: ' + e.message, 'error');
          this.addIaLog('Falha IA');
          this.setAIThinking(false);
        }
      }
    }
    const mud = new MUD();
    window.mud = mud;
  </script>
</body>
</html>
